<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3321/3321396.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N∆°i L∆∞u Gi·ªØ K·ª∑ Ni·ªám</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* GI·ªÆ NGUY√äN CSS C≈® */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #1c1e21; }
        .main-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; padding: 10px; }
        .confession-box { background: white; width: 100%; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); overflow: hidden; position: relative; }
        .header { padding: 16px; border-bottom: 1px solid #e4e6eb; text-align: center; font-weight: bold; font-size: 1.3rem; color: #1877f2; }
        .content-area { padding: 16px; }
        .input-group { margin-bottom: 12px; position: relative; }
        .input-group label { display: block; font-size: 0.9rem; color: #1c1e21; margin-bottom: 6px; font-weight: 600;}
        .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; outline: none; transition: border 0.2s, background 0.2s; }
        .input-field:focus { border-color: #1877f2; }
        .input-field:disabled { background-color: #f0f2f5; color: #65676b; cursor: not-allowed; }
        .change-info-btn { position: absolute; right: 0; top: 0; font-size: 0.8rem; color: #1877f2; cursor: pointer; text-decoration: underline; display: none; }
        textarea.confession-text { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 12px; resize: none; font-size: 1rem; min-height: 100px; outline: none; margin-bottom: 10px; font-family: inherit; }
        #fileInput { display: none; }
        .media-upload-btn { display: flex; justify-content: center; align-items: center; padding: 15px; background-color: #f7f8fa; border: 1px dashed #ccd0d5; color: #606770; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s; margin-bottom: 10px; }
        .media-upload-btn:hover { background-color: #ebedf0; }
        .media-upload-btn i { margin-right: 8px; color: #45bd62; font-size: 1.3rem; }
        #fileCount { display: block; text-align: center; font-size: 0.9rem; color: #1877f2; margin-bottom: 15px; font-weight: bold;}
        .submit-btn { width: 100%; padding: 14px; background-color: #1877f2; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .submit-btn:hover { background-color: #166fe5; }
        .submit-btn:disabled { background-color: #b0c4de; cursor: not-allowed; }
        #status { margin-top: 16px; padding: 12px; background-color: #e7f3ff; border-radius: 8px; font-size: 0.9rem; white-space: pre-line; display: none; color: #0c5460; }
        #memory-stats { text-align: center; font-size: 0.9rem; color: #65676b; margin-bottom: 15px; background: #f0f2f5; padding: 8px; border-radius: 6px; display: none; }
        #memory-stats strong { color: #1877f2; }
        
        /* Progress Bar */
        .progress-container { width: 100%; background: #e4e6eb; border-radius: 8px; height: 8px; margin: 10px 0; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #1877f2, #42b72a); transition: width 0.3s; width: 0%; }

        footer { width: 100%; text-align: center; padding: 20px; font-size: 0.85rem; color: #65676b; background: #fff; border-top: 1px solid #e4e6eb; margin-top: 20px; }
        footer a { color: #1877f2; text-decoration: none; font-weight: 600; cursor: pointer; }
        footer a:hover { text-decoration: underline; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; max-width: 90%; width: 450px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.25); transform: scale(0.9); transition: transform 0.3s ease; max-height: 80vh; overflow-y: auto; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-icon { font-size: 3rem; color: #1877f2; margin-bottom: 15px; }
        .modal-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 12px; }
        .modal-desc { font-size: 1rem; color: #666; margin-bottom: 25px; line-height: 1.6; text-align: left;}
        .modal-center-desc { text-align: center; }
        .modal-btn { padding: 12px 30px; background: #1877f2; color: white; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .close-modal-top { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }
        .policy-content p { margin-bottom: 10px; }
        .policy-content h4 { margin-top: 15px; margin-bottom: 5px; color: #333; }
    </style>
</head>
<body>

<div class="modal-overlay" id="introModal">
    <div class="modal-box">
        <div class="modal-icon"><i class="fas fa-camera-retro"></i></div>
        <div class="modal-title">Ch√†o b·∫°n!</div>
        <div class="modal-desc modal-center-desc">
            ƒê√¢y l√† n∆°i ƒë·ªÉ b·∫°n <b>t·∫£i l√™n ·∫£nh ho·∫∑c video k·ª∑ ni·ªám</b> c·ªßa m√¨nh.<br>
            T·∫•t c·∫£ k·ª∑ ni·ªám s·∫Ω ƒë∆∞·ª£c l∆∞u l·∫°i chung trong m·ªôt h·ªì s∆° ƒë·ªÉ g·ª≠i l·∫°i cho b·∫°n sau n√†y.<br><br>

            üìå <b>L∆∞u √Ω nh·ªè:</b><br>
            ‚Ä¢ M·ªói file t·ªëi ƒëa <b>100MB</b><br>
            ‚Ä¢ N√™n upload <b>1‚Äì2 ·∫£nh tr∆∞·ªõc</b> ƒë·ªÉ th·ª≠ xem c√≥ th√†nh c√¥ng kh√¥ng<br>
            ‚Ä¢ Khi th·∫•y <b>th√¥ng b√°o upload th√†nh c√¥ng</b> th√¨ m·ªõi ti·∫øp t·ª•c upload nhi·ªÅu ·∫£nh nh√©!<br><br>

            Tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu, b·∫°n vui l√≤ng ƒë·ªçc k·ªπ<br>
            <b><a onclick="openModal('privacyModal')">Ch√≠nh s√°ch & Quy·ªÅn Ri√™ng T∆∞</a></b>.
        </div>
        <button class="modal-btn" onclick="closeModal('introModal')">M√¨nh ƒë√£ hi·ªÉu</button>
    </div>
</div>

<div class="modal-overlay" id="privacyModal">
    <div class="modal-box" style="text-align: left;">
        <span class="close-modal-top" onclick="closeModal('privacyModal')">&times;</span>
        <div class="modal-title" style="text-align: center;">Ch√≠nh s√°ch & Quy·ªÅn Ri√™ng T∆∞</div>
        <div class="modal-desc policy-content">
            <p>
                Ch√†o b·∫°n! Tr∆∞·ªõc khi t·∫£i ·∫£nh ho·∫∑c video l√™n <b>N∆°i l∆∞u gi·ªØ k·ª∑ ni·ªám</b>, 
                b·∫°n h√£y ƒë·ªçc k·ªπ nh·ªØng ƒëi·ªÅu sau nh√©:
            </p>
            
            <h4>1. V·ªÅ vi·ªác s·ª≠ d·ª•ng h√¨nh ·∫£nh</h4>
            <p>
                Khi b·∫°n upload ·∫£nh ho·∫∑c video, b·∫°n ƒë·ªìng √Ω cho Ban qu·∫£n tr·ªã ƒë∆∞·ª£c s·ª≠ d·ª•ng 
                c√°c n·ªôi dung n√†y ƒë·ªÉ l√†m <b>k·ª∑ y·∫øu, video k·ª∑ ni·ªám, ho·∫∑c c√°c ho·∫°t ƒë·ªông chung c·ªßa l·ªõp</b>. 
                C√°c n·ªôi dung n√†y <b>kh√¥ng d√πng cho m·ª•c ƒë√≠ch th∆∞∆°ng m·∫°i</b>.
            </p>
            
            <h4>2. Quy·ªÅn ƒë·ªìng √Ω</h4>
            <p>
                ·∫¢nh v√† video b·∫°n t·∫£i l√™n c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng l·∫°i cho c√°c ho·∫°t ƒë·ªông chung 
                m√† <b>kh√¥ng c·∫ßn xin ph√©p l·∫°i t·ª´ng l·∫ßn</b>. 
                B·∫°n h√£y ch·∫Øc ch·∫Øn r·∫±ng ·∫£nh/video ƒë√≥ l√† do b·∫°n ch·ª•p ho·∫∑c ƒë∆∞·ª£c ph√©p s·ª≠ d·ª•ng nh√©.
            </p>

            <h4>3. Th√¥ng tin c√° nh√¢n</h4>
            <p>
                Email v√† t√™n l·ªõp ch·ªâ d√πng ƒë·ªÉ <b>l∆∞u ·∫£nh ƒë√∫ng th∆∞ m·ª•c</b> 
                v√† <b>g·ª≠i l·∫°i k·ª∑ ni·ªám cho b·∫°n sau n√†y</b>. 
                Ch√∫ng t√¥i cam k·∫øt <b>kh√¥ng chia s·∫ª th√¥ng tin n√†y cho ng∆∞·ªùi kh√°c</b>.
            </p>
        </div>
        <div style="text-align: center;">
            <button class="modal-btn" onclick="closeModal('privacyModal')">M√¨nh ƒë·ªìng √Ω</button>
        </div>
    </div>
</div>


<div class="main-wrapper">
    <div class="confession-box">
        <div class="header">N∆°i l∆∞u gi·ªØ k·ª∑ ni·ªám</div>
        <div class="content-area">
            <div class="input-group">
                <label>T√™n L·ªõp (V√≠ d·ª•: 6/1, 8/2,...)</label>
                <span class="change-info-btn" id="changeClassBtn" onclick="enableEdit()">[ƒê·ªïi th√¥ng tin]</span>
                <input type="text" class="input-field" id="classId" placeholder="Nh·∫≠p l·ªõp...">
            </div>
            <div class="input-group">
                <label>Email (D√πng chung cho c√°c l·∫ßn g·ª≠i)</label>
                <input type="email" class="input-field" id="userEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n...">
            </div>

            <div id="memory-stats">
                <i class="fas fa-spinner fa-spin"></i> ƒêang ki·ªÉm tra kho l∆∞u tr·ªØ...
            </div>

            <div class="input-group">
                 <label>L·ªùi nh·∫Øn g·ª≠i ho·∫∑c m√¥ t·∫£</label>
                <textarea class="confession-text" id="confessionText" placeholder="K·ªÉ v·ªÅ k·ª∑ ni·ªám n√†y..."></textarea>
            </div>
            <label for="fileInput" class="media-upload-btn">
                <i class="fas fa-images"></i> Ch·ªçn ·∫¢nh/Video (Max 100MB/file)
            </label>
            <span id="fileCount"></span>
            <input type="file" id="fileInput" multiple accept="image/*,video/*">
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <button class="submit-btn" id="uploadBtn" onclick="submitConfession()">G·ª≠i L∆∞u B√∫t</button>
            <div id="status"></div>
        </div>
    </div>
</div>

<footer>
    <div>&copy;Archive System 2026 v5</div>
    <div style="margin-top: 8px;">
        Li√™n h·ªá Admin: <a href="mailto:admin@email.com">G·ª≠i Mail</a> | 
        <a onclick="openModal('privacyModal')">Ch√≠nh s√°ch Quy·ªÅn ri√™ng t∆∞</a>
    </div>
</footer>
<script>
    // ============================================================
    // 1. C·∫§U H√åNH DROPBOX (ƒêI·ªÄN KEY C·ª¶A B·∫†N V√ÄO ƒê√ÇY)
    // ============================================================
    const DB_APP_KEY = 'gmrkyo6hyxilwcx'; 
    const DB_APP_SECRET = 'sgs2qwv8ajkmoej';
    const DB_REFRESH_TOKEN = '_6kRRl2INtYAAAAAAAAAAe3vMn04ROpuXPbugAFCwnJgEX9lFgGKoG4nwBG563Sa';

    // ============================================================
    // 2. LOGIC X·ª¨ L√ù TOKEN & API (Chuy·ªÉn t·ª´ Worker v·ªÅ ƒë√¢y)
    // ============================================================
    
    let cachedToken = null;
    let tokenExpiresAt = 0;

    async function getValidToken() {
        if (!cachedToken || Date.now() >= tokenExpiresAt) {
            console.log("Token expired or missing, refreshing...");
            return await refreshAccessToken();
        }
        return cachedToken;
    }

    async function refreshAccessToken() {
        try {
            const body = new URLSearchParams({
                grant_type: "refresh_token",
                refresh_token: DB_REFRESH_TOKEN,
                client_id: DB_APP_KEY,
                client_secret: DB_APP_SECRET,
            });

            const r = await fetch("https://api.dropbox.com/oauth2/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: body
            });

            if (!r.ok) {
                const txt = await r.text();
                throw new Error("L·ªói l·∫•y Token: " + txt);
            }

            const data = await r.json();
            cachedToken = data.access_token;
            // Tr·ª´ hao 2 ph√∫t
            tokenExpiresAt = Date.now() + (data.expires_in * 1000) - 120000;
            return cachedToken;
        } catch (e) {
            console.error(e);
            throw e;
        }
    }

    // ============================================================
    // 3. LOGIC APP CH√çNH
    // ============================================================
    
    // T·ª± ƒë·ªông ph√°t hi·ªán Mobile
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const PARALLEL_UPLOADS = isMobile ? 1 : 3;

    window.onload = function() {
        setTimeout(() => { document.getElementById('introModal').classList.add('active'); }, 500);
        loadUserData();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // --- Load User Data ---
    function loadUserData() {
        const savedClass = localStorage.getItem('user_class');
        const savedEmail = localStorage.getItem('user_email');
        if (savedClass && savedEmail) {
            document.getElementById('classId').value = savedClass;
            document.getElementById('userEmail').value = savedEmail;
            document.getElementById('classId').disabled = true;
            document.getElementById('userEmail').disabled = true;
            document.getElementById('changeClassBtn').style.display = 'inline';
            checkExistingMemories(savedClass, savedEmail);
        } else {
            document.getElementById('memory-stats').style.display = 'none';
        }
    }

    function enableEdit() {
        if (confirm("X√≥a th√¥ng tin c≈© ƒë·ªÉ nh·∫≠p l·∫°i?")) {
            localStorage.removeItem('user_class');
            localStorage.removeItem('user_email');
            location.reload();
        }
    }

    // --- Helper: Clean Filename ---
    function sanitizeFilename(str) {
        return str.normalize('NFD')
                  .replace(/[\u0300-\u036f]/g, '')
                  .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D')
                  .replace(/[^a-zA-Z0-9._-]/g, '_');
    }

    // --- API: Check Memory Stats (Profile) ---
    async function checkExistingMemories(classId, email) {
        const statsDiv = document.getElementById('memory-stats');
        statsDiv.style.display = 'block';
        
        const safeClassId = classId.trim().toUpperCase().replace(/[^A-Z0-9\/]/g, '-').replace(/\//g, '-');
        const safeEmail = email.trim().toLowerCase();
        const fullPath = `/Confession/${safeClassId}/${safeEmail}/profile.json`;

        try {
            const token = await getValidToken();
            
            // Download JSON t·ª´ Dropbox
            const r = await fetch("https://content.dropboxapi.com/2/files/download", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Dropbox-API-Arg": JSON.stringify({ path: fullPath })
                }
            });

            if (r.status === 409 || r.status === 404) {
                statsDiv.innerHTML = 'Ch√†o b·∫°n m·ªõi! B·∫°n ch∆∞a c√≥ k·ª∑ ni·ªám n√†o.';
                return;
            }

            if (!r.ok) throw new Error("Dropbox API Error");

            const profile = await r.json();
            let totalFiles = 0;
            if (Array.isArray(profile.history)) {
                for (const s of profile.history) {
                    if (Array.isArray(s.files)) {
                        totalFiles += s.files.length;
                    }
                }
            }
            statsDiv.innerHTML = `B·∫°n ƒëang l∆∞u gi·ªØ <strong>${totalFiles}</strong> k·ª∑ ni·ªám t·∫°i ƒë√¢y.`;

        } catch (e) {
            console.error(e);
            statsDiv.innerHTML = '‚ö†Ô∏è Kh√¥ng th·ªÉ ki·ªÉm tra (C√≥ th·ªÉ do CORS ch·∫∑n).';
        }
    }

    // --- API: Create Folder ---
    async function ensureFolderExists(folderPath) {
        try {
            const token = await getValidToken();
            const r = await fetch("https://api.dropboxapi.com/2/files/create_folder_v2", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ path: folderPath, autorename: false })
            });

            if (!r.ok && r.status !== 409) { // 409 means folder exists
                const txt = await r.text();
                console.warn("Create folder warning:", txt);
            }
            return true;
        } catch (e) {
            console.error("Create folder error:", e);
            // V·∫´n return true ƒë·ªÉ code ch·∫°y ti·∫øp, v√¨ c√≥ th·ªÉ folder ƒë√£ c√≥
            return true;
        }
    }

    // --- API: Upload File ---
    async function uploadToDropboxWithRetry(file, folderPath, maxRetries = 5) {
        let delay = 1000;
        const token = await getValidToken();
        
        for (let i = 0; i < maxRetries; i++) {
            try {
                const fullPath = `${folderPath}/${file.name}`;
                const args = { 
                    "path": fullPath, 
                    "mode": "add", 
                    "autorename": true, 
                    "mute": false 
                };
                
                // Upload tr·ª±c ti·∫øp l√™n content.dropboxapi.com
                const response = await fetch("https://content.dropboxapi.com/2/files/upload", {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/octet-stream', 
                        'Dropbox-API-Arg': JSON.stringify(args) 
                    },
                    body: file // Tr√¨nh duy·ªát t·ª± x·ª≠ l√Ω File object th√†nh binary
                });
                
                if (response.ok) return true;
                
                if (response.status >= 500) {
                    throw new Error("Server Error 5xx");
                } else {
                    console.error(`Upload failed: ${response.status} ${await response.text()}`);
                    return false;
                }
            } catch (error) { 
                console.warn(`Retry ${i+1}/${maxRetries} for ${file.name}`, error);
                if (i < maxRetries - 1) {
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }
        return false;
    }

    // --- API: Update JSON Profile ---
    async function updateProfileJsonWithRetry(folderPath, email, classId, sessionData) {
        let retries = 3; 
        while (retries > 0) {
            try {
                const token = await getValidToken();
                const jsonFileName = "profile.json";
                const fullPath = `${folderPath}/${jsonFileName}`;
                
                let profile = { 
                    user_email: email, 
                    user_class: classId, 
                    created_at: new Date().toISOString(), 
                    last_updated: new Date().toISOString(), 
                    history: [] 
                };

                // 1. Th·ª≠ t·∫£i JSON c≈© v·ªÅ
                try {
                    const downloadResp = await fetch("https://content.dropboxapi.com/2/files/download", {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Dropbox-API-Arg': JSON.stringify({ "path": fullPath }) 
                        }
                    });
                    if (downloadResp.ok) {
                        profile = await downloadResp.json();
                    }
                } catch (e) {
                    console.log("JSON ch∆∞a t·ªìn t·∫°i, s·∫Ω t·∫°o m·ªõi.");
                }

                // 2. C·∫≠p nh·∫≠t d·ªØ li·ªáu
                profile.history.push(sessionData);
                profile.last_updated = new Date().toISOString();

                // 3. Upload ƒë√® l·∫°i (Overwrite)
                const jsonBlob = new Blob([JSON.stringify(profile, null, 2)], { type: 'application/json' });
                const args = { "path": fullPath, "mode": "overwrite", "autorename": false, "mute": true };

                const uploadResp = await fetch("https://content.dropboxapi.com/2/files/upload", {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/octet-stream', 
                        'Dropbox-API-Arg': JSON.stringify(args) 
                    },
                    body: jsonBlob
                });
                
                if (!uploadResp.ok) throw new Error("L·ªói upload JSON");
                return; // Success

            } catch (e) {
                console.warn("L·ªói update JSON, th·ª≠ l·∫°i...", e);
                retries--;
                await new Promise(r => setTimeout(r, 1000));
            }
        }
        console.error("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t JSON");
    }

    // --- Parallel Upload Logic ---
    async function uploadFilesInParallel(files, folderPath, onProgress) {
        const results = [];
        const queue = [...files];
        let completed = 0;
        
        async function uploadWorker() {
            while (queue.length > 0) {
                const file = queue.shift();
                if (!file) break;
                
                const result = await uploadToDropboxWithRetry(file, folderPath, 3);
                results.push({ file: file.name, success: result });
                completed++;
                
                if (onProgress) onProgress(completed, files.length);
            }
        }
        
        const workers = Array(Math.min(PARALLEL_UPLOADS, files.length)).fill(null).map(() => uploadWorker());
        await Promise.all(workers);
        return results;
    }

    // --- MAIN SUBMIT FUNCTION ---
    const fileInput = document.getElementById('fileInput');
    const fileCountSpan = document.getElementById('fileCount');
    
    fileInput.addEventListener('change', function() {
        fileCountSpan.textContent = this.files.length > 0 ? `ƒê√£ ch·ªçn ${this.files.length} file` : '';
    });

    async function submitConfession() {
        if (!DB_APP_KEY || DB_APP_KEY.includes('ƒêI·ªÄN')) {
            alert("‚ö†Ô∏è B·∫°n ch∆∞a ƒëi·ªÅn API KEY trong code HTML!");
            return;
        }

        const classId = document.getElementById('classId').value.trim().toUpperCase().replace(/[^A-Z0-9\/]/g, '-');
        const email = document.getElementById('userEmail').value.trim().toLowerCase();
        const textContent = document.getElementById('confessionText').value.trim();
        const files = fileInput.files;
        const btn = document.getElementById('uploadBtn');
        const statusDiv = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        if (!classId || !email) { 
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p T√™n L·ªõp v√† Email!"); 
            return; 
        }
        if (files.length === 0 && textContent === "") { 
            alert("‚ö†Ô∏è H√£y ch·ªçn ·∫£nh ho·∫∑c vi·∫øt l·ªùi nh·∫Øn!"); 
            return; 
        }

        localStorage.setItem('user_class', classId);
        localStorage.setItem('user_email', email);

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
        statusDiv.style.display = 'block';
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        
        const safeClassId = classId.replace(/\//g, '-');
        const folderPath = `/Confession/${safeClassId}/${email}`;
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);

        try {
            // 1. Init Folder
            statusDiv.innerHTML = "üìÅ ƒêang kh·ªüi t·∫°o th∆∞ m·ª•c...";
            await ensureFolderExists(folderPath);

            // 2. Prepare Files
            let fileQueue = [];
            for (let i = 0; i < files.length; i++) {
                if (files[i].size > 100 * 1024 * 1024) {
                    alert(`‚ö†Ô∏è File "${files[i].name}" l·ªõn h∆°n 100MB b·ªè qua.`);
                    continue;
                }
                const safeName = sanitizeFilename(files[i].name);
                const finalName = `${timestamp}_${safeName}`;
                // T·∫°o file m·ªõi v·ªõi t√™n ƒë√£ clean
                fileQueue.push(new File([files[i]], finalName, {type: files[i].type}));
            }

            // 3. Upload
            let successfulFileNames = [];
            if (fileQueue.length > 0) {
                statusDiv.innerHTML = "üöÄ ƒêang t·∫£i l√™n song song...";
                const results = await uploadFilesInParallel(fileQueue, folderPath, (completed, total) => {
                    const percent = Math.round((completed / total) * 100);
                    progressBar.style.width = percent + '%';
                    statusDiv.innerHTML = `üì§ ƒêang t·∫£i: ${completed}/${total} files (${percent}%)`;
                });
                successfulFileNames = results.filter(r => r.success).map(r => r.file);
            }

            // 4. Update Log
            if (successfulFileNames.length > 0 || textContent !== "") {
                progressBar.style.width = '95%';
                statusDiv.innerHTML = "üìù ƒêang ghi v√†o l∆∞u b√∫t...";
                
                const currentSession = { 
                    uploaded_at: new Date().toISOString(), 
                    note: textContent, 
                    files: successfulFileNames 
                };
                
                await updateProfileJsonWithRetry(folderPath, email, classId, currentSession);
                
                progressBar.style.width = '100%';
                statusDiv.innerHTML = `‚úÖ <b>Ho√†n t·∫•t!</b> ƒê√£ l∆∞u ${successfulFileNames.length} file. H·∫πn b·∫°n trong t∆∞∆°ng lai`;
                
                checkExistingMemories(classId, email);
                // Reset
                document.getElementById('confessionText').value = "";
                fileInput.value = "";
                fileCountSpan.textContent = "";
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 3000);
            } else {
                statusDiv.innerHTML = `‚ùå L·ªói ho·∫∑c kh√¥ng c√≥ g√¨ ƒë·ªÉ l∆∞u.`;
            }

        } catch (e) {
            console.error(e);
            statusDiv.innerHTML = `‚ùå L·ªói nghi√™m tr·ªçng: ${e.message}`;
            alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng ki·ªÉm tra Console (F12) ƒë·ªÉ xem chi ti·∫øt l·ªói CORS ho·∫∑c M·∫°ng.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'G·ª≠i L∆∞u B√∫t';
        }
    }
</script>
</body>
</html>


